workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - when: always

stages:
  - test
  - build

Code Quality:
  stage: test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: always
  script:
    - rm -rf civenv
    - virtualenv -p python3 --system-site-packages civenv
    - . ./civenv/bin/activate
    - pip3 install -I mypy
    - pip3 install -I git+https://dev.gajim.org/gajim/python-nbxmpp.git@nbxmpp_2.0
    - pip3 install -I pylint==2.4.4
    - pip3 install -I codespell
    - pip3 install -I coverage
    - pip3 install -I css-parser
    - pip3 install -I keyring
    - pip3 install -I packaging
    - pip3 install -I precis-i18n
    - pip3 install -I pyOpenSSL
    - mypy -V
    - mypy gajim
    - scripts/ci/pylint.sh --jobs=2 gajim
    - coverage run --source=gajim -m unittest discover -s test/no_gui -v
    - coverage report -mi
    - coverage xml -i
    - codespell -I codespell.conf --skip="*__pycache__*,gajim/data/icons,gajim/data/sounds,gajim/data/emoticons" gajim
    - deactivate
    - rm -rf civenv
  coverage: "/TOTAL.+ ([0-9]{1,3}%)/"
  artifacts:
    reports:
      cobertura: coverage.xml
  interruptible: true

appdata.xml:
  stage: test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: always
  script:
    - python3 setup.py build
    - appstream-util validate build/data/org.gajim.Gajim.appdata.xml
  interruptible: true

Linux:
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: always
  script:
    - ./scripts/ci/sdist.py

  artifacts:
    name: "gajim-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHA"
    expire_in: 1 week
    paths:
      - dist/gajim-*.tar.gz
  interruptible: true

Windows:
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  script:
    - ./scripts/ci/appveyor.py
